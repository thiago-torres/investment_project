<!-- Topbar -->
<nav class="navbar navbar-expand navbar-light bg-white topbar static-top shadow">
    <!-- Sidebar Toggle (Topbar) -->
    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
        <i class="fa fa-bars"></i>
    </button>

    <!-- Flex Container for Prices -->
    <div class="d-flex align-items-center ml-auto">
        <!-- Bitcoin Price Display -->
        <div class="d-flex align-items-center mr-4">
            <i class="fas fa-coins btc-icon"></i>
            <span class="price-display">
                BTC/USD: <span id="btcPrice">Loading...</span>
                (<span id="btcChange" class="">0.00%</span>)
            </span>
        </div>

        <!-- IBOVESPA Price Display -->
        <div class="d-flex align-items-center">
            <i class="fas fa-chart-line ibov-icon"></i>
            <span class="price-display">
                IBOVESPA: <span id="ibovPrice">Loading...</span>
                (<span id="ibovChange" class="">0.00%</span>)
            </span>
        </div>
    </div>
</nav>

<!-- WebSocket Script -->
<script>
    let lastClosePrice = 0; // Preço de fechamento do último dia
    const socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');

    // Função para obter o preço de fechamento do último período
    async function getLastClosePrice() {
        const response = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
        const data = await response.json();
        lastClosePrice = parseFloat(data.prevClosePrice);
    }

    // Calcular a variação e atualizar o preço
    socket.onmessage = function(event) {
        const message = JSON.parse(event.data);
        const currentPrice = parseFloat(message.p).toFixed(2);
        const priceElement = document.getElementById('btcPrice');
        const changeElement = document.getElementById('btcChange');

        priceElement.innerText = currentPrice;

        if (lastClosePrice) {
            const change = ((currentPrice - lastClosePrice) / lastClosePrice * 100).toFixed(2);
            changeElement.innerText = `${change}%`;

            // Alterar cor conforme o preço
            if (change >= 0) {
                priceElement.classList.remove('price-down');
                priceElement.classList.add('price-up');
                changeElement.classList.remove('price-down');
                changeElement.classList.add('price-up');
            } else {
                priceElement.classList.remove('price-up');
                priceElement.classList.add('price-down');
                changeElement.classList.remove('price-up');
                changeElement.classList.add('price-down');
            }
        }
    };

    // Obter o preço de fechamento ao carregar a página
    getLastClosePrice();



    let lastCloseIbovPrice = 0; // Preço de fechamento do último dia para o IBOVESPA

    // Função para obter o preço de fechamento do IBOVESPA
    async function getIbovData() {
        const response = await fetch('/ibovespa');  // Chamando o proxy server
        const data = await response.json();

        // Acessando os dados corretamente
        const lastClose = data.chart.result[0].meta.chartPreviousClose;
        const currentPrice = data.chart.result[0].indicators.quote[0].close[0];

        const priceElement = document.getElementById('ibovPrice');
        const changeElement = document.getElementById('ibovChange');

        priceElement.innerText = currentPrice.toFixed(2);

        const change = ((currentPrice - lastClose) / lastClose * 100).toFixed(2);
        changeElement.innerText = `${change}%`;

        if (change >= 0) {
            priceElement.classList.remove('price-down');
            priceElement.classList.add('price-up');
            changeElement.classList.remove('price-down');
            changeElement.classList.add('price-up');
        } else {
            priceElement.classList.remove('price-up');
            priceElement.classList.add('price-down');
            changeElement.classList.remove('price-up');
            changeElement.classList.add('price-down');
        }
    }

    getIbovData();

</script>